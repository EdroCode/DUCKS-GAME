<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<style type="text/css">
span.lineno { color: white; background: #aaaaaa; border-right: solid white 12px }
span.nottickedoff { background: yellow}
span.istickedoff { background: white }
span.tickonlyfalse { margin: -1px; border: 1px solid #f20913; background: #f20913 }
span.tickonlytrue  { margin: -1px; border: 1px solid #60de51; background: #60de51 }
span.funcount { font-size: small; color: orange; z-index: 2; position: absolute; right: 20 }
span.decl { font-weight: bold }
span.spaces    { background: white }
</style>
</head>
<body>
<pre>
<span class="decl"><span class="nottickedoff">never executed</span> <span class="tickonlytrue">always true</span> <span class="tickonlyfalse">always false</span></span>
</pre>
<pre>
<span class="lineno">    1 </span>{-# OPTIONS_GHC -w #-}
<span class="lineno">    2 </span>
<span class="lineno">    3 </span>-- | Este ficheiro contém *magia* para correr o feedback. Nâo tem nada de útil para o projeto. Ignorem o mais que puderem!
<span class="lineno">    4 </span>module Magic where
<span class="lineno">    5 </span>
<span class="lineno">    6 </span>import Control.Monad
<span class="lineno">    7 </span>import Data.String
<span class="lineno">    8 </span>import Data.Word
<span class="lineno">    9 </span>import Data.Int
<span class="lineno">   10 </span>import qualified Web.Browser as Browser
<span class="lineno">   11 </span>import qualified Network.URI.Encode as URI
<span class="lineno">   12 </span>import qualified Data.ByteString.Base64 as Base64
<span class="lineno">   13 </span>import qualified Data.ByteString as BS
<span class="lineno">   14 </span>import qualified Data.ByteString.Char8 as BS8
<span class="lineno">   15 </span>import Data.Bits.Coded
<span class="lineno">   16 </span>import Data.Bits.Coding
<span class="lineno">   17 </span>import Data.Bytes.Put (runPutS,MonadPut)
<span class="lineno">   18 </span>import Data.Bytes.Get (runGetS,MonadGet)
<span class="lineno">   19 </span>import GHC.Generics
<span class="lineno">   20 </span>import Control.DeepSeq
<span class="lineno">   21 </span>import Control.Exception
<span class="lineno">   22 </span>
<span class="lineno">   23 </span>import Labs2025
<span class="lineno">   24 </span>
<span class="lineno">   25 </span>-- * Feedback
<span class="lineno">   26 </span>
<span class="lineno">   27 </span>type Error a = Either String a
<span class="lineno">   28 </span>
<span class="lineno">   29 </span><span class="decl"><span class="nottickedoff"><span class="decl"><span class="nottickedoff">deriving instance Generic Terreno</span></span></span></span>
<span class="lineno">   30 </span>instance <span class="decl"><span class="nottickedoff">NFData Terreno</span></span>
<span class="lineno">   31 </span>
<span class="lineno">   32 </span><span class="decl"><span class="nottickedoff"><span class="decl"><span class="nottickedoff">deriving instance Generic Objeto</span></span></span></span>
<span class="lineno">   33 </span>instance <span class="decl"><span class="nottickedoff">NFData Objeto</span></span>
<span class="lineno">   34 </span>
<span class="lineno">   35 </span><span class="decl"><span class="nottickedoff"><span class="decl"><span class="nottickedoff">deriving instance Generic VidaMinhoca</span></span></span></span>
<span class="lineno">   36 </span>instance <span class="decl"><span class="nottickedoff">NFData VidaMinhoca</span></span>
<span class="lineno">   37 </span>
<span class="lineno">   38 </span><span class="decl"><span class="nottickedoff"><span class="decl"><span class="nottickedoff">deriving instance Generic Minhoca</span></span></span></span>
<span class="lineno">   39 </span>instance <span class="decl"><span class="nottickedoff">NFData Minhoca</span></span>
<span class="lineno">   40 </span>
<span class="lineno">   41 </span><span class="decl"><span class="nottickedoff"><span class="decl"><span class="nottickedoff">deriving instance Generic TipoArma</span></span></span></span>
<span class="lineno">   42 </span>instance <span class="decl"><span class="nottickedoff">NFData TipoArma</span></span>
<span class="lineno">   43 </span>
<span class="lineno">   44 </span><span class="decl"><span class="nottickedoff"><span class="decl"><span class="nottickedoff">deriving instance Generic Direcao</span></span></span></span>
<span class="lineno">   45 </span>instance <span class="decl"><span class="nottickedoff">NFData Direcao</span></span>
<span class="lineno">   46 </span>
<span class="lineno">   47 </span><span class="decl"><span class="nottickedoff"><span class="decl"><span class="nottickedoff">deriving instance Generic Jogada</span></span></span></span>
<span class="lineno">   48 </span>instance <span class="decl"><span class="nottickedoff">NFData Jogada</span></span>
<span class="lineno">   49 </span>
<span class="lineno">   50 </span><span class="decl"><span class="nottickedoff"><span class="decl"><span class="nottickedoff">deriving instance Generic Estado</span></span></span></span>
<span class="lineno">   51 </span>instance <span class="decl"><span class="nottickedoff">NFData Estado</span></span>
<span class="lineno">   52 </span>
<span class="lineno">   53 </span>data TaskData
<span class="lineno">   54 </span>    = T1 { <span class="nottickedoff"><span class="decl"><span class="nottickedoff">t1_inputs</span></span></span> :: [Estado], <span class="nottickedoff"><span class="decl"><span class="nottickedoff">t1_outputs</span></span></span> :: [Error Bool] }
<span class="lineno">   55 </span>    | T2 { <span class="nottickedoff"><span class="decl"><span class="nottickedoff">t2_inputs</span></span></span> :: [(NumMinhoca,Jogada,Estado)], <span class="nottickedoff"><span class="decl"><span class="nottickedoff">t2_outputs</span></span></span> :: [Error Estado] }
<span class="lineno">   56 </span>    | T3 { <span class="nottickedoff"><span class="decl"><span class="nottickedoff">t3_inputs</span></span></span> :: [Estado], <span class="nottickedoff"><span class="decl"><span class="nottickedoff">t3_outputs</span></span></span> :: [Error Estado] }
<span class="lineno">   57 </span>    | T4 { <span class="nottickedoff"><span class="decl"><span class="nottickedoff">t4_inputs</span></span></span> :: [Estado], <span class="nottickedoff"><span class="decl"><span class="nottickedoff">t4_outputs</span></span></span> :: [Error [(NumMinhoca,Jogada)]] }
<span class="lineno">   58 </span>    deriving (<span class="decl"><span class="nottickedoff"><span class="decl"><span class="nottickedoff">Eq</span></span></span></span>,<span class="decl"><span class="nottickedoff"><span class="decl"><span class="nottickedoff"><span class="decl"><span class="nottickedoff"><span class="decl"><span class="nottickedoff"><span class="decl"><span class="nottickedoff"><span class="decl"><span class="nottickedoff"><span class="decl"><span class="nottickedoff">Ord</span></span></span></span></span></span></span></span></span></span></span></span></span></span>,<span class="decl"><span class="nottickedoff"><span class="decl"><span class="nottickedoff"><span class="decl"><span class="nottickedoff">Show</span></span></span></span></span></span>,<span class="decl"><span class="nottickedoff"><span class="decl"><span class="nottickedoff"><span class="decl"><span class="nottickedoff"><span class="decl"><span class="nottickedoff">Read</span></span></span></span></span></span></span></span>,<span class="decl"><span class="nottickedoff"><span class="decl"><span class="nottickedoff">Generic</span></span></span></span>)
<span class="lineno">   59 </span>
<span class="lineno">   60 </span>instance <span class="decl"><span class="nottickedoff">NFData TaskData</span></span>
<span class="lineno">   61 </span>
<span class="lineno">   62 </span>taskNumber :: TaskData -&gt; Int
<span class="lineno">   63 </span><span class="decl"><span class="istickedoff">taskNumber (T1 {}) = 1</span>
<span class="lineno">   64 </span><span class="spaces"></span><span class="istickedoff">taskNumber (T2 {}) = <span class="nottickedoff">2</span></span>
<span class="lineno">   65 </span><span class="spaces"></span><span class="istickedoff">taskNumber (T3 {}) = <span class="nottickedoff">3</span></span>
<span class="lineno">   66 </span><span class="spaces"></span><span class="istickedoff">taskNumber (T4 {}) = <span class="nottickedoff">4</span></span></span>
<span class="lineno">   67 </span>
<span class="lineno">   68 </span>runTest :: NFData a =&gt; a -&gt; IO (Error a)
<span class="lineno">   69 </span><span class="decl"><span class="istickedoff">runTest a = catch (evaluate $! force $! Right a) <span class="nottickedoff">onError</span></span>
<span class="lineno">   70 </span><span class="spaces">    </span><span class="istickedoff">where</span>
<span class="lineno">   71 </span><span class="spaces">    </span><span class="istickedoff">onError :: SomeException -&gt; IO (Error a)</span>
<span class="lineno">   72 </span><span class="spaces">    </span><span class="istickedoff"><span class="nottickedoff">onError e = return $! Left $! show e</span></span></span>
<span class="lineno">   73 </span>
<span class="lineno">   74 </span>runFeedback :: TaskData -&gt; IO ()
<span class="lineno">   75 </span><span class="decl"><span class="istickedoff">runFeedback dta = do</span>
<span class="lineno">   76 </span><span class="spaces">    </span><span class="istickedoff">let feedbackpage = &quot;https://haslab.github.io/Teaching/LI1/2526/feedback.html&quot;</span>
<span class="lineno">   77 </span><span class="spaces">    </span><span class="istickedoff">let feedbackfile = &quot;t&quot; ++ show (taskNumber dta) ++ &quot;.feedback&quot;</span>
<span class="lineno">   78 </span><span class="spaces">    </span><span class="istickedoff">let <span class="nottickedoff">bytes = encToBytes dta</span></span>
<span class="lineno">   79 </span><span class="spaces">    </span><span class="istickedoff">let base64 = encToBase64 dta</span>
<span class="lineno">   80 </span><span class="spaces">    </span><span class="istickedoff">writeFile feedbackfile base64</span>
<span class="lineno">   81 </span><span class="spaces">    </span><span class="istickedoff">let uri = feedbackpage ++ &quot;?flags=&quot; ++ URI.encode base64</span>
<span class="lineno">   82 </span><span class="spaces">    </span><span class="istickedoff">_ &lt;- Browser.openBrowser uri</span>
<span class="lineno">   83 </span><span class="spaces">    </span><span class="istickedoff">putStrLn $ &quot;* Página de feedback aberta no browser.&quot;</span>
<span class="lineno">   84 </span><span class="spaces">    </span><span class="istickedoff">putStrLn $ &quot;* Se não conseguir visualizar faça upload do ficheiro &quot; ++ show feedbackfile ++ &quot; em &quot; ++ show feedbackpage ++ &quot;.&quot;</span></span>
<span class="lineno">   85 </span>
<span class="lineno">   86 </span>-- * bit stuff
<span class="lineno">   87 </span>
<span class="lineno">   88 </span>type BitEncoder a = forall m. MonadPut m =&gt; a -&gt; Coding m ()
<span class="lineno">   89 </span>type BitDecoder a = forall m. MonadGet m =&gt; Coding m a
<span class="lineno">   90 </span>type Bytes = BS.ByteString
<span class="lineno">   91 </span>
<span class="lineno">   92 </span>encToBytes :: Coded a =&gt; a -&gt; Bytes
<span class="lineno">   93 </span><span class="decl"><span class="istickedoff">encToBytes a = runPutS $ runEncode $ encode a &gt;&gt; putAligned (return <span class="nottickedoff">()</span>)</span></span>
<span class="lineno">   94 </span>
<span class="lineno">   95 </span>decFromBytes :: Coded a =&gt; Bytes -&gt; Maybe a
<span class="lineno">   96 </span><span class="decl"><span class="nottickedoff">decFromBytes bytes = case runGetS (runDecode decode) bytes of</span>
<span class="lineno">   97 </span><span class="spaces">    </span><span class="nottickedoff">Left err -&gt; Nothing</span>
<span class="lineno">   98 </span><span class="spaces">    </span><span class="nottickedoff">Right a -&gt; Just a</span></span>
<span class="lineno">   99 </span>
<span class="lineno">  100 </span>instance <span class="decl"><span class="nottickedoff"><span class="decl"><span class="nottickedoff">Monad m =&gt; Semigroup (Coding m ())</span></span></span></span> where
<span class="lineno">  101 </span>    <span class="decl"><span class="istickedoff">x &lt;&gt; y = x &gt;&gt; y</span></span>
<span class="lineno">  102 </span>
<span class="lineno">  103 </span>instance <span class="decl"><span class="istickedoff">Monad m =&gt; Monoid (Coding m ())</span></span> where
<span class="lineno">  104 </span>    <span class="decl"><span class="istickedoff">mempty = return <span class="nottickedoff">()</span></span></span>
<span class="lineno">  105 </span>    <span class="decl"><span class="istickedoff">mappend x y = x &gt;&gt; y</span></span>
<span class="lineno">  106 </span>
<span class="lineno">  107 </span>instance <span class="decl"><span class="nottickedoff">Coded Bool</span></span> where
<span class="lineno">  108 </span>    <span class="decl"><span class="istickedoff">encode b = putBit b</span></span>
<span class="lineno">  109 </span>    <span class="decl"><span class="nottickedoff">decode = getBit</span></span>
<span class="lineno">  110 </span>
<span class="lineno">  111 </span>instance <span class="decl"><span class="nottickedoff">Coded Int</span></span> where
<span class="lineno">  112 </span>    <span class="decl"><span class="istickedoff">encode = encodeAsInt32</span></span>
<span class="lineno">  113 </span>    <span class="decl"><span class="nottickedoff">decode = decodeAsInt32</span></span>
<span class="lineno">  114 </span>
<span class="lineno">  115 </span>instance <span class="decl"><span class="nottickedoff">Coded Word8</span></span> where
<span class="lineno">  116 </span>    <span class="decl"><span class="nottickedoff">encode = encodeAsWord8</span></span>
<span class="lineno">  117 </span>    <span class="decl"><span class="nottickedoff">decode = decodeAsWord8</span></span>
<span class="lineno">  118 </span>
<span class="lineno">  119 </span>instance <span class="decl"><span class="nottickedoff">Coded BS.ByteString</span></span> where
<span class="lineno">  120 </span>    <span class="decl"><span class="nottickedoff">encode = encode . BS.unpack</span></span>
<span class="lineno">  121 </span>    <span class="decl"><span class="nottickedoff">decode = liftM BS.pack decode</span></span>
<span class="lineno">  122 </span>
<span class="lineno">  123 </span>instance {-# OVERLAPS #-} <span class="decl"><span class="nottickedoff">Coded String</span></span> where
<span class="lineno">  124 </span>    <span class="decl"><span class="nottickedoff">encode = encode . BS8.pack</span></span>
<span class="lineno">  125 </span>    <span class="decl"><span class="nottickedoff">decode = liftM BS8.unpack decode</span></span>
<span class="lineno">  126 </span>
<span class="lineno">  127 </span>instance <span class="decl"><span class="nottickedoff">(Coded a,Coded b) =&gt; Coded (a,b)</span></span> where
<span class="lineno">  128 </span>    <span class="decl"><span class="istickedoff">encode (a,b) = encode a &lt;&gt; encode b</span></span>
<span class="lineno">  129 </span>    <span class="decl"><span class="nottickedoff">decode = decode &gt;&gt;= \a -&gt; decode &gt;&gt;= \b -&gt; return (a,b)</span></span>
<span class="lineno">  130 </span>
<span class="lineno">  131 </span>instance <span class="decl"><span class="nottickedoff">(Coded a,Coded b,Coded c) =&gt; Coded (a,b,c)</span></span> where
<span class="lineno">  132 </span>    <span class="decl"><span class="nottickedoff">encode (a,b,c) = encode a &lt;&gt; encode b &lt;&gt; encode c</span></span>
<span class="lineno">  133 </span>    <span class="decl"><span class="nottickedoff">decode = decode &gt;&gt;= \a -&gt; decode &gt;&gt;= \b -&gt; decode &gt;&gt;= \c -&gt; return (a,b,c)</span></span>
<span class="lineno">  134 </span>
<span class="lineno">  135 </span>instance <span class="decl"><span class="nottickedoff">(Coded a,Coded b) =&gt; Coded (Either a b)</span></span> where
<span class="lineno">  136 </span>    <span class="decl"><span class="istickedoff">encode (Left  a) = <span class="nottickedoff">encode False &gt;&gt; encode a</span></span>
<span class="lineno">  137 </span><span class="spaces">    </span><span class="istickedoff">encode (Right b) = encode True &gt;&gt; encode b</span></span>
<span class="lineno">  138 </span>    <span class="decl"><span class="nottickedoff">decode = decode &gt;&gt;= \b -&gt; case b of</span>
<span class="lineno">  139 </span><span class="spaces">        </span><span class="nottickedoff">False -&gt; liftM Left decode </span>
<span class="lineno">  140 </span><span class="spaces">        </span><span class="nottickedoff">True -&gt; liftM Right decode</span></span>
<span class="lineno">  141 </span>
<span class="lineno">  142 </span>instance <span class="decl"><span class="nottickedoff">Coded a =&gt; Coded (Maybe a)</span></span> where
<span class="lineno">  143 </span>    <span class="decl"><span class="istickedoff">encode Nothing = encode False</span>
<span class="lineno">  144 </span><span class="spaces">    </span><span class="istickedoff">encode (Just a) = encode True &lt;&gt; encode a</span></span>
<span class="lineno">  145 </span>    <span class="decl"><span class="nottickedoff">decode = decode &gt;&gt;= \b -&gt; case b of</span>
<span class="lineno">  146 </span><span class="spaces">        </span><span class="nottickedoff">False -&gt; return Nothing</span>
<span class="lineno">  147 </span><span class="spaces">        </span><span class="nottickedoff">True -&gt; decode &gt;&gt;= \a -&gt; return (Just a)</span></span>
<span class="lineno">  148 </span>
<span class="lineno">  149 </span>instance {-# OVERLAPPABLE #-} <span class="decl"><span class="nottickedoff">Coded a =&gt; Coded [a]</span></span> where
<span class="lineno">  150 </span>    <span class="decl"><span class="istickedoff">encode xs = encodeAsWord32 (length xs) &lt;&gt; mconcat (map encode xs)</span></span>
<span class="lineno">  151 </span>    <span class="decl"><span class="nottickedoff">decode = decodeAsWord32 &gt;&gt;= \sz -&gt; replicateM sz decode</span></span>
<span class="lineno">  152 </span>
<span class="lineno">  153 </span>instance <span class="decl"><span class="nottickedoff">Coded Estado</span></span> where
<span class="lineno">  154 </span>    <span class="decl"><span class="istickedoff">encode e = encode (mapaEstado e) &lt;&gt; encode (objetosEstado e) &lt;&gt; encode (minhocasEstado e)</span></span>
<span class="lineno">  155 </span>    <span class="decl"><span class="nottickedoff">decode = decode &gt;&gt;= \mapa -&gt; decode &gt;&gt;= \objetos -&gt; decode &gt;&gt;= \minhocas -&gt; return (Estado mapa objetos minhocas)</span></span>
<span class="lineno">  156 </span>
<span class="lineno">  157 </span>instance <span class="decl"><span class="nottickedoff">Coded Jogada</span></span> where
<span class="lineno">  158 </span>    <span class="decl"><span class="nottickedoff">encode (Dispara arma dir) = encode False &lt;&gt; encode arma &lt;&gt; encode dir</span>
<span class="lineno">  159 </span><span class="spaces">    </span><span class="nottickedoff">encode (Move dir) = encode True &lt;&gt; encode dir</span></span>
<span class="lineno">  160 </span>    <span class="decl"><span class="nottickedoff">decode = decode &gt;&gt;= \b -&gt; case b of</span>
<span class="lineno">  161 </span><span class="spaces">        </span><span class="nottickedoff">False -&gt; decode &gt;&gt;= \arma -&gt; decode &gt;&gt;= \dir -&gt; return (Dispara arma dir)</span>
<span class="lineno">  162 </span><span class="spaces">        </span><span class="nottickedoff">True -&gt; decode &gt;&gt;= \dir -&gt; return (Move dir)</span></span>
<span class="lineno">  163 </span>
<span class="lineno">  164 </span>instance <span class="decl"><span class="nottickedoff">Coded Objeto</span></span> where
<span class="lineno">  165 </span>    <span class="decl"><span class="istickedoff">encode (Barril posicao explode) = encode False &lt;&gt; encode posicao &lt;&gt; encode explode</span>
<span class="lineno">  166 </span><span class="spaces">    </span><span class="istickedoff">encode (Disparo posicao dir tipo tempo dono) = encode True &lt;&gt; encode posicao &lt;&gt; encode dir &lt;&gt; encode tipo &lt;&gt; encode tempo &lt;&gt; encode dono</span></span>
<span class="lineno">  167 </span>    <span class="decl"><span class="nottickedoff">decode = decode &gt;&gt;= \b -&gt; case b of</span>
<span class="lineno">  168 </span><span class="spaces">        </span><span class="nottickedoff">False -&gt; decode &gt;&gt;= \posicao -&gt; decode &gt;&gt;= \explode -&gt; return (Barril posicao explode)</span>
<span class="lineno">  169 </span><span class="spaces">        </span><span class="nottickedoff">True -&gt; decode &gt;&gt;= \posicao -&gt; decode &gt;&gt;= \dir -&gt; decode &gt;&gt;= \tipo -&gt; decode &gt;&gt;= \tempo -&gt; decode &gt;&gt;= \dono -&gt; return (Disparo posicao dir tipo tempo dono)</span></span>
<span class="lineno">  170 </span>    
<span class="lineno">  171 </span>instance <span class="decl"><span class="nottickedoff">Coded Minhoca</span></span> where
<span class="lineno">  172 </span>    <span class="decl"><span class="istickedoff">encode (Minhoca pos vida jet esc baz min din) = encode pos &lt;&gt; encode vida &lt;&gt; encode jet &lt;&gt; encode esc &lt;&gt; encode baz &lt;&gt; encode min &lt;&gt; encode din</span></span>
<span class="lineno">  173 </span>    <span class="decl"><span class="nottickedoff">decode = decode &gt;&gt;= \pos -&gt; decode &gt;&gt;= \vida -&gt; decode &gt;&gt;= \jet -&gt; decode &gt;&gt;= \esc -&gt; decode &gt;&gt;= \baz -&gt; decode &gt;&gt;= \min -&gt; decode &gt;&gt;= \din -&gt; return (Minhoca pos vida jet esc baz min din)</span></span>
<span class="lineno">  174 </span>
<span class="lineno">  175 </span>instance <span class="decl"><span class="nottickedoff">Coded VidaMinhoca</span></span> where
<span class="lineno">  176 </span>    <span class="decl"><span class="istickedoff">encode Morta = encode False</span>
<span class="lineno">  177 </span><span class="spaces">    </span><span class="istickedoff">encode (Viva i) = encode True &lt;&gt; encode i</span></span>
<span class="lineno">  178 </span>    <span class="decl"><span class="nottickedoff">decode = decode &gt;&gt;= \b -&gt; case b of</span>
<span class="lineno">  179 </span><span class="spaces">        </span><span class="nottickedoff">False -&gt; return Morta</span>
<span class="lineno">  180 </span><span class="spaces">        </span><span class="nottickedoff">True -&gt; decode &gt;&gt;= \i -&gt; return (Viva i)</span></span>
<span class="lineno">  181 </span>    
<span class="lineno">  182 </span>instance <span class="decl"><span class="nottickedoff">Coded Terreno</span></span> where
<span class="lineno">  183 </span>    <span class="decl"><span class="istickedoff">encode t = encodeAsWord2 (fromEnum t)</span></span>
<span class="lineno">  184 </span>    <span class="decl"><span class="nottickedoff">decode = liftM toEnum decodeAsWord2</span></span>
<span class="lineno">  185 </span>
<span class="lineno">  186 </span>instance <span class="decl"><span class="nottickedoff">Coded Direcao</span></span> where
<span class="lineno">  187 </span>    <span class="decl"><span class="istickedoff">encode t = encodeAsWord3 (fromEnum t)</span></span>
<span class="lineno">  188 </span>    <span class="decl"><span class="nottickedoff">decode = liftM toEnum decodeAsWord3</span></span>
<span class="lineno">  189 </span>
<span class="lineno">  190 </span>instance <span class="decl"><span class="nottickedoff">Coded TipoArma</span></span> where
<span class="lineno">  191 </span>    <span class="decl"><span class="istickedoff">encode t = encodeAsWord3 (fromEnum t)</span></span>
<span class="lineno">  192 </span>    <span class="decl"><span class="nottickedoff">decode = liftM toEnum decodeAsWord3</span></span>
<span class="lineno">  193 </span>
<span class="lineno">  194 </span>instance <span class="decl"><span class="nottickedoff">Coded TaskData</span></span> where
<span class="lineno">  195 </span>    <span class="decl"><span class="istickedoff">encode (T1 i o) = encodeAsWord2 (0::Int) &lt;&gt; encode i &lt;&gt; encode o</span>
<span class="lineno">  196 </span><span class="spaces">    </span><span class="istickedoff">encode (T2 i o) = <span class="nottickedoff">encodeAsWord2 (1::Int) &lt;&gt; encode i &lt;&gt; encode o</span></span>
<span class="lineno">  197 </span><span class="spaces">    </span><span class="istickedoff">encode (T3 i o) = <span class="nottickedoff">encodeAsWord2 (2::Int) &lt;&gt; encode i &lt;&gt; encode o</span></span>
<span class="lineno">  198 </span><span class="spaces">    </span><span class="istickedoff">encode (T4 i o) = <span class="nottickedoff">encodeAsWord2 (3::Int) &lt;&gt; encode i &lt;&gt; encode o</span></span></span>
<span class="lineno">  199 </span>    <span class="decl"><span class="nottickedoff">decode = decodeAsWord2 &gt;&gt;= \(w::Int) -&gt; case w of</span>
<span class="lineno">  200 </span><span class="spaces">        </span><span class="nottickedoff">0 -&gt; decode &gt;&gt;= \i -&gt; decode &gt;&gt;= \o -&gt; return (T1 i o)</span>
<span class="lineno">  201 </span><span class="spaces">        </span><span class="nottickedoff">1 -&gt; decode &gt;&gt;= \i -&gt; decode &gt;&gt;= \o -&gt; return (T2 i o)</span>
<span class="lineno">  202 </span><span class="spaces">        </span><span class="nottickedoff">2 -&gt; decode &gt;&gt;= \i -&gt; decode &gt;&gt;= \o -&gt; return (T3 i o)</span>
<span class="lineno">  203 </span><span class="spaces">        </span><span class="nottickedoff">3 -&gt; decode &gt;&gt;= \i -&gt; decode &gt;&gt;= \o -&gt; return (T4 i o)</span>
<span class="lineno">  204 </span><span class="spaces">        </span><span class="nottickedoff">_ -&gt; fail &quot;unknown TaskData&quot;</span></span>
<span class="lineno">  205 </span>
<span class="lineno">  206 </span>encodeAsWord2 :: Integral n =&gt; BitEncoder n
<span class="lineno">  207 </span><span class="decl"><span class="istickedoff">encodeAsWord2 = mconcat . map encode . numberToBits 2</span></span>
<span class="lineno">  208 </span>    
<span class="lineno">  209 </span>decodeAsWord2 :: Integral n =&gt; BitDecoder n
<span class="lineno">  210 </span><span class="decl"><span class="nottickedoff">decodeAsWord2 = liftM numberFromBits $ replicateM 2 decode</span></span>
<span class="lineno">  211 </span>
<span class="lineno">  212 </span>encodeAsWord3 :: Integral n =&gt; BitEncoder n
<span class="lineno">  213 </span><span class="decl"><span class="istickedoff">encodeAsWord3 = mconcat . map encode . numberToBits 3</span></span>
<span class="lineno">  214 </span>    
<span class="lineno">  215 </span>decodeAsWord3 :: Integral n =&gt; BitDecoder n
<span class="lineno">  216 </span><span class="decl"><span class="nottickedoff">decodeAsWord3 = liftM numberFromBits $ replicateM 3 decode</span></span>
<span class="lineno">  217 </span>
<span class="lineno">  218 </span>encodeAsWord8 :: Integral n =&gt; BitEncoder n
<span class="lineno">  219 </span><span class="decl"><span class="nottickedoff">encodeAsWord8 = mconcat . map encode . numberToBits 8</span></span>
<span class="lineno">  220 </span>    
<span class="lineno">  221 </span>decodeAsWord8 :: Integral n =&gt; BitDecoder n
<span class="lineno">  222 </span><span class="decl"><span class="nottickedoff">decodeAsWord8 = liftM numberFromBits $ replicateM 8 decode</span></span>
<span class="lineno">  223 </span>
<span class="lineno">  224 </span>encodeAsWord32 :: Integral n =&gt; BitEncoder n
<span class="lineno">  225 </span><span class="decl"><span class="istickedoff">encodeAsWord32 = mconcat . map encode . numberToBits 32</span></span>
<span class="lineno">  226 </span>
<span class="lineno">  227 </span>decodeAsWord32 :: Integral n =&gt; BitDecoder n
<span class="lineno">  228 </span><span class="decl"><span class="nottickedoff">decodeAsWord32 = liftM numberFromBits $ replicateM 32 decode</span></span>
<span class="lineno">  229 </span>
<span class="lineno">  230 </span>int32ToWord32 :: Int32 -&gt; Word32
<span class="lineno">  231 </span><span class="decl"><span class="istickedoff">int32ToWord32 = fromIntegral</span></span>
<span class="lineno">  232 </span>
<span class="lineno">  233 </span>word32ToInt32 :: Word32 -&gt; Int32
<span class="lineno">  234 </span><span class="decl"><span class="nottickedoff">word32ToInt32 w</span>
<span class="lineno">  235 </span><span class="spaces">    </span><span class="nottickedoff">| w &lt;= fromIntegral (maxBound :: Int32) = fromIntegral w</span>
<span class="lineno">  236 </span><span class="spaces">    </span><span class="nottickedoff">| otherwise = fromIntegral (w - 2^(32::Int32))</span></span>
<span class="lineno">  237 </span>
<span class="lineno">  238 </span>encodeAsInt32 :: Integral n =&gt; BitEncoder n
<span class="lineno">  239 </span><span class="decl"><span class="istickedoff">encodeAsInt32 = encodeAsWord32 . int32ToWord32 . fromIntegral</span></span>
<span class="lineno">  240 </span>
<span class="lineno">  241 </span>decodeAsInt32 :: Integral n =&gt; BitDecoder n
<span class="lineno">  242 </span><span class="decl"><span class="nottickedoff">decodeAsInt32 = liftM (fromIntegral . word32ToInt32) decodeAsWord32</span></span>
<span class="lineno">  243 </span>
<span class="lineno">  244 </span>numberToBits :: Integral n =&gt; Int -&gt; n -&gt; [Bool]
<span class="lineno">  245 </span><span class="decl"><span class="istickedoff">numberToBits sz = reverse . pad . conv</span>
<span class="lineno">  246 </span><span class="spaces">  </span><span class="istickedoff">where</span>
<span class="lineno">  247 </span><span class="spaces">    </span><span class="istickedoff">conv :: Integral n =&gt; n -&gt; [Bool]</span>
<span class="lineno">  248 </span><span class="spaces">    </span><span class="istickedoff">conv 0 = []</span>
<span class="lineno">  249 </span><span class="spaces">    </span><span class="istickedoff">conv x = (x `mod` 2 == 1) : conv (x `div` 2)</span>
<span class="lineno">  250 </span><span class="spaces">    </span><span class="istickedoff">pad :: [Bool] -&gt; [Bool]</span>
<span class="lineno">  251 </span><span class="spaces">    </span><span class="istickedoff">pad bits = take sz (bits ++ repeat False)</span></span>
<span class="lineno">  252 </span>
<span class="lineno">  253 </span>numberFromBits :: Integral n =&gt; [Bool] -&gt; n
<span class="lineno">  254 </span><span class="decl"><span class="nottickedoff">numberFromBits = foldr (\bit acc -&gt; (if bit then 1 else 0) + 2 * acc) 0 . reverse</span></span>
<span class="lineno">  255 </span>
<span class="lineno">  256 </span>-- * base64 stuff
<span class="lineno">  257 </span>
<span class="lineno">  258 </span>encToBase64 :: Coded a =&gt; a -&gt; String
<span class="lineno">  259 </span><span class="decl"><span class="istickedoff">encToBase64 = BS8.unpack . Base64.encode . encToBytes</span></span>
<span class="lineno">  260 </span>
<span class="lineno">  261 </span>decFromBase64 :: Coded a =&gt; String -&gt; Maybe a
<span class="lineno">  262 </span><span class="decl"><span class="nottickedoff">decFromBase64 = decFromBytes . Base64.decodeLenient . fromString</span></span>

</pre>
</body>
</html>
